<!DOCTYPE html>
<html>
<head>
    <title>M-Lab Speed Test</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
        .test-section { border: 1px solid #ccc; border-radius: 8px; padding: 16px; margin-bottom: 20px; }
        .test-section h2 { margin-top: 0; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:disabled { background-color: #ccc; }
        .results-grid { display: grid; grid-template-columns: 150px 1fr; gap: 5px; }
        .results-grid span { font-weight: bold; }
    </style>
</head>
<body>

    <h1>M-Lab Speed Test App</h1>

    <div class="test-section">
        <h2>1. Speed Test (M-Lab)</h2>
        <button id="start-speed-test">Start Speed Test</button>
        <div class="results-grid" style="margin-top: 15px;">
            <span>Download:</span> <span id="dl-speed">...</span>
            <span>Upload:</span> <span id="ul-speed">...</span>
            <span>Latency:</span> <span id="latency">...</span>
        </div>
    </div>

    <script src="https://unpkg.com/@m-lab/ndt7-js@0.9.0/dist/ndt7.js"></script>
    
    <script>
        
        // --- Library loading check ---
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof ndt7 === 'undefined') {
                alert("CRITICAL ERROR: The ndt7 script did not load. This is caused by an ad blocker, network firewall, or browser extension. Please disable them and hard-refresh.");
                const btn = document.getElementById('start-speed-test');
                btn.disabled = true;
                btn.textContent = "Speed Test (Error)";
            }
        });

        // --- Speed Test Logic ---
        document.getElementById('start-speed-test').addEventListener('click', runSpeedTest);

        async function runSpeedTest() {
            this.disabled = true;
            const dlSpan = document.getElementById('dl-speed');
            const ulSpan = document.getElementById('ul-speed');
            const latSpan = document.getElementById('latency');

            dlSpan.textContent = "Connecting...";
            ulSpan.textContent = "..."; 
            latSpan.textContent = "...";
            
            const client = new ndt7.Client();
            
            let uploadTestStarted = false; 
            
            client.onmeasurement = (measurement) => {
                if (measurement.kind === 'download') {
                    if (measurement.throughput?.Value) {
                        dlSpan.textContent = `${(measurement.throughput.Value / 1000).toFixed(2)} Mbps`;
                    } else {
                        dlSpan.textContent = "Running Download...";
                    }
                }
                
                if (measurement.kind === 'upload') {
                    if (!uploadTestStarted) {
                        ulSpan.textContent = "Running Upload...";
                        uploadTestStarted = true;
                    }
                    if (measurement.throughput?.Value) {
                        ulSpan.textContent = `${(measurement.throughput.Value / 1000).toFixed(2)} Mbps`;
                    }
                }
                
                if (measurement.kind === 'latency') {
                     if (measurement.rtt?.Value) {
                        latSpan.textContent = `${measurement.rtt.Value.toFixed(0)} ms`;
                     } else {
                        latSpan.textContent = "Testing Latency...";
                     }
                }
            };

            try {
                await client.start();
                
                const summary = await client.getSummary();
                dlSpan.textContent = `${(summary.download.throughput.Value / 1000).toFixed(2)} Mbps (Final)`;
                ulSpan.textContent = `${(summary.upload.throughput.Value / 1000).toFixed(2)} Mbps (Final)`;
                latSpan.textContent = `${summary.latency.Value.toFixed(0)} ms (Final)`;

            } catch (err) {
                console.error("Speed test failed:", err.message);
                dlSpan.textContent = "error";
                ulSpan.textContent = "error";
                latSpan.textContent = "error";
            } finally {
                // Re-enable button only if the library was loaded
                if (typeof ndt7 !== 'undefined') {
                    document.getElementById('start-speed-test').disabled = false;
                }
            }
        }
    </script>
</body>
</html>